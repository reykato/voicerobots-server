<!DOCTYPE HTML>
<!--
 This file contains code from the JoyStick Project (https://github.com/bobboteck/JoyStick).
 Copyright (c) 2015 Roberto D'Amico (Bobboteck).
-->
<html>
	<head>
		<title>RPi Joystick</title>
		<meta charset="utf-8">
		<meta name="description" content="Joystick to control robot through websockets">
		<script src="/static/joy.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/style.css">
    </head>
	<body>
        <!-- <audio controls autoplay>
            <source src="/audio_feed" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio> -->
		<div class="container">
            <div class="row">
                <div class="col">
                    <img class="rounded img-fluid" src="{{ url_for('video_feed') }}">
                </div>
                <div class="col">
                    <div class="row">
                        <h1>Joystick Control</h1>
                        <h4>overrides autonomous control</h4>
                        <div id="joyDiv" style="width:300px;height:300px;margin:50px;"></div>
                    </div>
                    <div class="row">
                        <div class="form-group row">
                            <label for="exampleInputEmail1">Command</label>
                            <input type="text" class="form-control" id="textInput" placeholder="Enter Command">
                            <button type="submit" class="btn btn-primary" onclick="submitText()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

		<script type="text/javascript">
            var socket = io();
            socket.on('connect', function() {
                socket.emit('my event', {data: 'I\'m connected!'});
            });

            var joyParam = { 
              "title": "joystick",
              internalFillColor: '#00b2d1',
              internalStrokeColor: '#008096',
              externalStrokeColor: '#FFFFFF'
            };
            var Joy = new JoyStick('joyDiv', joyParam);

            let chunks = [];

            // Get audio stream from user microphone
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                const mediaRecorder = new MediaRecorder(stream, { mimeType:"audio/webm; codecs=pcm" })
                mediaRecorder.start(1000);
                console.log(mediaRecorder.state)
                mediaRecorder.ondataavailable = (e) => {
                    console.log("data available");
                    chunks.push(e.data);
                  };
              })

            function send_audio_data() {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                socket.emit('audio', blob);
                console.log("audio sent");
                console.log(blob);
                chunks = [];
            }

            setInterval(send_audio_data, 1000); // Send audio data every 5s

            function send_joystick_data() {
                var entry = {
                    x: Joy.GetX(),
                    y: Joy.GetY()
                }

                fetch(`${window.origin}/joystick/data`, {
                    method: "POST",
                    credentials: "omit",
                    body: JSON.stringify(entry),
                    cache: "no-cache",
                    headers: new Headers({
                        "content-type": "application/json"
                    })
                })
            }

            function send_joystick_data_websocket() {
              var entry = {
                    x: Joy.GetX(),
                    y: Joy.GetY()
              }

              socket.emit('json', entry);
            }

            setInterval(send_joystick_data_websocket, 100);

            // Handles submitting text via the textbox and submit button
            function submitText() {
                var textValue = document.getElementById("textInput").value;
                fetch('/submit_text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: textValue }),
                })
            }
		</script>
	</body>
</html>
